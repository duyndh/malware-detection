using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows.Forms;
using WindowsFormsApp1.Controls;
using static WindowsFormsApp1.Controls.MiningUserControl;

namespace WindowsFormsApp1.Controllers
{
    public class MiningController
    {
        MiningUserControl _userControl = null;
        public const string RESOURCE_DIR = "";//"..\\..\\..\\..\\Resources\\";

        [DllImport(RESOURCE_DIR + "NativeLib.dll")]
        public extern static void Test();

        [DllImport(RESOURCE_DIR + "NativeLib.dll")]
        public extern static bool DisassemblyFile(string input_file_path, string asm_file_path, string output_file_path);

        [DllImport(RESOURCE_DIR + "NativeLib.dll")]
        public extern static bool BuildInstructionsGraph(string input_file_path, string output_file_path);

        [DllImport(RESOURCE_DIR + "NativeLib.dll")]
        public extern static bool BuildGraphFromFile(string input_file_path, string asm_file_path, string output_file_path);

        HashSet<string> _inputFileHashes = new HashSet<string>();

        public MiningController(MiningUserControl userControl) { _userControl = userControl; }

        public bool StartFileMining(string inputPath, string asmPath, DataFormatEnum srcFormat, string outputPath, DataFormatEnum dstFormat)
        {
            bool result = false;
            try
            {
                do
                {
                    var fileHash = Wrapper.CalculateFileHash(inputPath);
                    if (_inputFileHashes.Contains(fileHash))
                        break;

                    _inputFileHashes.Add(fileHash);

                    if (srcFormat == DataFormatEnum.Raw || srcFormat == DataFormatEnum.Assembly)
                    {
                        if (dstFormat == DataFormatEnum.Standard)
                        {
                            if (!DisassemblyFile(inputPath, asmPath, outputPath))
                                break;
                        }
                        else if (dstFormat == DataFormatEnum.Graph)
                        {
                            if (!BuildGraphFromFile(inputPath, asmPath, outputPath))
                                break;
                        }
                        else
                            break;
                    }
                    else if (srcFormat == DataFormatEnum.Standard)
                    {
                        if (dstFormat == DataFormatEnum.Graph)
                        {
                            if (!BuildInstructionsGraph(inputPath, outputPath))
                                break;
                        }
                        else
                            break;
                    }
                    else
                        break;
                
                    result = true;

                } while (false);
            }
            catch (Exception ex) { }

            return result;
        }

        public bool StartMining(string srcLocation, DataFormatEnum srcFormat, string dstLocation, DataFormatEnum dstFormat, int dstCountLimit, bool onlyPeExts)
        {
            var paths = new List<Tuple<string, string, string>>();

            do
            {
                var dstExt = "";
                if (dstFormat == DataFormatEnum.Standard)
                {
                    dstExt = STANDARD_EXT;
                }
                else if (dstFormat == DataFormatEnum.Graph)
                {
                    dstExt = GRAPH_EXT;
                }
                else
                    break;

                if (srcFormat == DataFormatEnum.Raw)
                {
                    var inputPaths = Wrapper.EnumerateDirectoryFiles(srcLocation, "*.*", SearchOption.AllDirectories)
                        .Where(path => onlyPeExts ? PE_EXTS.Contains(Path.GetExtension(path)) : true)
                        .ToArray();

                    foreach (var inputPath in inputPaths)
                    {
                        var outputName = Wrapper.ConvertToAlphaNumString(inputPath) + dstExt;
                        var outputPath = Path.Combine(dstLocation, outputName);
                        //if (outputPath.Length > Wrapper.MAX_PATH)
                        //    outputPath = Path.Combine(dstLocation, outputName.Substring(Wrapper.MAX_PATH - outputPath.Length));                        

                        paths.Add(new Tuple<string, string, string>(inputPath, "", outputPath));
                    }
                }
                else if (srcFormat == DataFormatEnum.Assembly)
                {
                    var inputPaths = Wrapper.EnumerateDirectoryFiles(srcLocation, "*" + BYTES_EXT, SearchOption.AllDirectories).ToArray();
                    foreach (var inputPath in inputPaths)
                    {
                        var asmPath = Path.ChangeExtension(inputPath, ASM_EXT);
                        if (!File.Exists(asmPath))
                            continue;

                        var outputName = Wrapper.ConvertToAlphaNumString(inputPath) + dstExt;
                        var outputPath = Path.Combine(dstLocation, outputName);
                        //if (outputPath.Length > Wrapper.MAX_PATH)
                        //    outputPath = Path.Combine(dstLocation, outputName.Substring(Wrapper.MAX_PATH - outputPath.Length));

                        paths.Add(new Tuple<string, string, string>(inputPath, asmPath, outputPath));
                    }
                }
                else if (srcFormat == DataFormatEnum.Standard)
                {
                    var inputPaths = Wrapper.EnumerateDirectoryFiles(srcLocation, "*" + STANDARD_EXT, SearchOption.AllDirectories).ToArray();
                    foreach (var inputPath in inputPaths)
                    {
                        var outputName = Wrapper.ConvertToAlphaNumString(inputPath) + dstExt;
                        var outputPath = Path.Combine(dstLocation, outputName);
                        //if (outputPath.Length > Wrapper.MAX_PATH)
                        //    outputPath = Path.Combine(dstLocation, outputName.Substring(Wrapper.MAX_PATH - outputPath.Length));

                        paths.Add(new Tuple<string, string, string>(inputPath, "", outputPath));
                    }
                }
                else
                    break;

                // Start
                int outputCount = 0;
                foreach (var path in paths)
                {
                    if (outputCount >= dstCountLimit)
                        break;

                    if (StartFileMining(path.Item1, path.Item2, srcFormat, path.Item3, dstFormat))
                    {
                        outputCount++;
                    }
                    else
                    {
                        Logger.Log(Logger.LogType.ERROR, path.Item1);
                    }
                }

            } while (false);

            _userControl.SetStartProgressBar(100);
            MessageBox.Show("Done");
            _userControl.SetStartButtonState(true);

            return true;
        }
    }
}
