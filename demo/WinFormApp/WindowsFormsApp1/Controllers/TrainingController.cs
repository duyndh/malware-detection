using IronPython.Hosting;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using WindowsFormsApp1.UserControls;
using static WindowsFormsApp1.Home;
using static WindowsFormsApp1.UserControls.TrainingUserControl;

namespace WindowsFormsApp1.Controllers
{
    public class TrainingController
    {
        TrainingUserControl _userControl = null;

        private const string PYTHON_PATH = @"C:\Setup\venv\Scripts\python.exe";

        private string _output = string.Empty;
        public string GetOutput() { return _output; }

        public TrainingController(TrainingUserControl userControl) { _userControl = userControl; }

        public bool StartTraining(int featureIndex, int sequenceLength, float testRatio, int reducedSize,
            string benignDir, int benignLimitCount, string malwareDir, int malwareLimitCount, string outputFilePath, int[] classifierIndexs)
        {
            bool result = false;

            _output = string.Empty;

            do
            {
                var pyAppDir = Path.Combine(Wrapper.GetRootDir(), "PyApp");
                var cmdPath = Environment.ExpandEnvironmentVariables(@"%WinDir%\System32\cmd.exe");
                var scriptsDir = Environment.ExpandEnvironmentVariables(@"%HOMEDRIVE%\Setup\venv\Scripts");
                var pythonDir = Path.Combine(scriptsDir, "python.exe");

                ProcessStartInfo startInfo = new ProcessStartInfo();
                startInfo.FileName = cmdPath;
                startInfo.WorkingDirectory = pyAppDir;

                startInfo.Arguments = string.Format("/k " + "\"" +
                    "cd /d \"\"" + scriptsDir + "\"\"" +
                    " & activate.bat" +
                    " & cd /d \"\"" + pyAppDir + "\"\"" + 
                    " & main.py {0} {1} {2} {3} \"\"{4}\"\" {5} \"\"{6}\"\" {7} \"\"{8}\"\" {9}" +
                    " & exit(0)" +
                    "\"",
                    featureIndex,
                    sequenceLength,
                    testRatio,
                    reducedSize,
                    benignDir,
                    benignLimitCount,
                    malwareDir,
                    malwareLimitCount,
                    outputFilePath,
                    string.Join(" ", classifierIndexs)
                );

                startInfo.UseShellExecute = false;
                startInfo.RedirectStandardOutput = true;
                startInfo.CreateNoWindow = true;

                using (var process = Process.Start(startInfo))
                {
                    process.WaitForExit();

                    using (var reader = process.StandardOutput)
                    {
                        _output = reader.ReadToEnd();
                        _userControl.WriteToOutputRichTextBoxContent(_output);
                    }
                }

            } while (false);

            _userControl.SetStartProgressBar(100);

            MessageBox.Show("Done");
            _userControl.SetStartButtonState(true);

            return result;
        }
    }
}
