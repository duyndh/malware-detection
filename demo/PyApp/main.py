import glob
import os
from datetime import datetime

from dataset_loader import *
from feature_extractor import *
from trainer import *

def load_args():

    if True:
        if not os.environ.get("EDITH_feature_id") is None:
            GlobalVar.feature_id = int(os.environ.get("EDITH_feature_id"))

        if not os.environ.get("EDITH_sequence_len") is None:
            GlobalVar.sequence_len = int(os.environ.get("EDITH_sequence_len"))

        if not os.environ.get("EDITH_test_ratio") is None:
            GlobalVar.test_ratio = float(os.environ.get("EDITH_test_ratio"))

        if not os.environ.get("EDITH_reduced_size") is None:
            GlobalVar.reduced_size = int(os.environ.get("EDITH_reduced_size"))

        if not os.environ.get("EDITH_benign_dirs") is None:
            GlobalVar.benign_dirs = os.environ.get("EDITH_benign_dirs").split(";")

        if not os.environ.get("EDITH_benign_limit") is None:
            GlobalVar.benign_limit = int(os.environ.get("EDITH_benign_limit"))

        if not os.environ.get("EDITH_malware_dirs") is None:
            GlobalVar.malware_dirs = os.environ.get("EDITH_malware_dirs").split(";")

        if not os.environ.get("EDITH_malware_limit") is None:
            GlobalVar.malware_limit = int(os.environ.get("EDITH_malware_limit"))

        if not os.environ.get("EDITH_classifier_ids") is None:
            GlobalVar.classifier_ids = [int(x) for x in os.environ.get("EDITH_classifier_ids").split(" ")]

        if not os.environ.get("EDITH_output_dir") is None:
            GlobalVar.output_dir = os.environ.get("EDITH_output_dir")

    GlobalVar.prefix_file_name = datetime.now().strftime("%d%m%Y%H%M%S")
    GlobalVar.log_file_path = os.path.join(GlobalVar.output_dir, GlobalVar.prefix_file_name + ".txt")

    log("feature: " + FeatureEnum.get_name(GlobalVar.feature_id))
    log("sequence len: " + str(GlobalVar.sequence_len))
    log("test ratio: " + str(GlobalVar.test_ratio))
    log("reduced size: " + str(GlobalVar.reduced_size))
    log("benign dirs: " + str(GlobalVar.benign_dirs))
    log("benign limit: " + str(GlobalVar.benign_limit))
    log("malware dirs: " + str(GlobalVar.malware_dirs))
    log("malware limit: " + str(GlobalVar.malware_limit))
    log("classifiers: " + str([ClassifierEnum.get_name(id) for id in GlobalVar.classifier_ids]))
    log("output dir: " + GlobalVar.output_dir)

    log("prefix file name: " + GlobalVar.prefix_file_name)

    return


def load_graphs_from_directories(directories, limit_count):

    graphs = []
    for directory in directories:
        log("directory: " + directory)

        find_pattern = os.path.join(directory, "**", "*.gcsv")
        file_paths = glob.glob(find_pattern, recursive=True)
        file_count = min(len(file_paths), limit_count - len(graphs))

        file_index = 1
        new_graphs = []

        for file_path in file_paths:

            if file_index > file_count:
                break

            log("{0}/{1} {2}".format(file_index, file_count, file_path))

            new_graphs.append(DatasetLoader.load_graph_file(file_path))
            file_index += 1

        log("found: " + str(len(new_graphs)))
        graphs += new_graphs

    return graphs


def train_dataset(benign_samples, malware_samples):

    log("benign count: " + str(len(benign_samples)))
    log("malware count: " + str(len(malware_samples)))

    X = benign_samples + malware_samples
    y = [0 for x in range(len(benign_samples))] + [1 for x in range(len(malware_samples))]

    for classifier_id in GlobalVar.classifier_ids:

        try:
            Trainer.train_k_fold(classifier_id, X, y)
            Trainer.train_full(classifier_id, X, y)

        except Exception as e:
            log("ERROR: " + str(e))

    return


def log(msg):
    now_time = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
    append_to_file(GlobalVar.log_file_path, now_time + " " + msg + "\n")
    print(msg)


if __name__ == '__main__':

    # args
    load_args()

    try:

        # load benign
        log("loading benign samples...")
        benign_graphs = load_graphs_from_directories(GlobalVar.benign_dirs, GlobalVar.benign_limit)

        # load malware
        log("loading malware samples...")
        malware_graphs = load_graphs_from_directories(GlobalVar.malware_dirs, GlobalVar.malware_limit)

        # train
        log("training...")
        train_dataset(benign_graphs, malware_graphs)

        log("DONE")

    except Exception as e:
        log("ERROR: " + str(e))

    exit(0)
