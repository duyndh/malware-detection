# This is a sample Python script.

# Press Shift+F10 to execute it or replace it with your code.
# Press Double Shift to search everywhere for classes, files, tool windows, actions, and settings.

import os
import pefile
import csv
import hashlib

def filter_pe_files(dataset_dir, data_csv_name):

    print("================")
    print(filter_pe_files.__name__)

    pe_files = []

    percentage = 0
    print(0, "%")

    for root_path, directory_names, file_names in os.walk(dataset_dir):
        for file_index, file_name in enumerate(file_names):

            if (int)(file_index * 100 / len(file_names)) > percentage:
                percentage = (int)(file_index * 100 / len(file_names))
                print(percentage, "%")

            file_path = os.path.join(root_path, file_name)

            try:
                # Parse PE file
                pe = pefile.PE(file_path)

                # Get machine type
                machine = pe.FILE_HEADER.Machine

                # Only accept x64 and x86 machine type
                if machine == 0x8664 or machine == 0x14c:

                    # Calculate checksum
                    checksum = hashlib.md5(open(file_path, 'rb').read()).hexdigest()
                    if any(pe for pe in pe_files if pe["md5"] == checksum):
                        continue

                    # Add to result
                    pe_files.append({"name": file_name, "machine": machine, "md5": checksum})

                else:
                    continue

            except:
                pass

        break

    print("Saving...")

    out_file_path = os.path.join(dataset_dir, data_csv_name)

    with open(out_file_path, 'w', newline='') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=["name", "machine", "md5"])
        writer.writeheader()
        for pe_file in pe_files:
            writer.writerow(pe_file)

    print(100, "%")

    pass

# Press the green button in the gutter to run the script.
if __name__ == '__main__':

    dataset_dir = os.path.expanduser("~/Downloads/Virus.Win")
    data_csv_name = "_malware.csv"

    filter_pe_files(dataset_dir, data_csv_name)

    print("DONE")
    pass

# See PyCharm help at https://www.jetbrains.com/help/pycharm/
