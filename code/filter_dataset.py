import os
import pefile
import csv
import hashlib
import random

def filter_pe_files(dataset_dir, data_csv_name):

    print("================")
    print(filter_pe_files.__name__)

    pe_files = []

    percentage = 0
    print(0, "%")

    for root_path, directory_names, file_names in os.walk(dataset_dir):

        randomized_file_indexes = [x for x in range(0, len(file_names))]
        random.shuffle(randomized_file_indexes)

        for index, file_index in enumerate(randomized_file_indexes):

            if (int)(index * 100 / len(randomized_file_indexes)) > percentage:
                percentage = (int)(index * 100 / len(randomized_file_indexes))
                print(percentage, "%")

            file_path = os.path.join(root_path, file_names[file_index])

            try:
                # Parse PE file
                pe = pefile.PE(file_path)

                # Get machine type
                machine = pe.FILE_HEADER.Machine

                # Only accept x64 and x86 machine type
                if machine == 0x8664 or machine == 0x14c:

                    # Calculate checksum
                    checksum = hashlib.md5(open(file_path, 'rb').read()).hexdigest()
                    if any(pe for pe in pe_files if pe["md5"] == checksum):
                        continue

                    # Add to result
                    pe_files.append({"name": file_names[file_index], "machine": machine, "md5": checksum})

            except:
                pass

        break

    print("Saving...")

    out_file_path = os.path.join(dataset_dir, data_csv_name)

    with open(out_file_path, 'w', newline='') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=["name", "machine", "md5"])
        writer.writeheader()
        for pe_file in pe_files:
            writer.writerow(pe_file)

    print(100, "%")

    pass

# Press the green button in the gutter to run the script.
if __name__ == '__main__':

    dataset_dir = os.path.expanduser("~/Downloads/Virus.Win")
    data_csv_name = "_malware.csv"

    filter_pe_files(dataset_dir, data_csv_name)

    print("DONE")
    pass

# See PyCharm help at https://www.jetbrains.com/help/pycharm/
