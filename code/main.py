from opcode_dataset_generator import *
from raw_dataset_generator import *
from feature_extractor import *
from data_trainer import *

import sys
import platform


root_dir = ""
if platform.system() == 'Linux':
    root_dir = os.path.expanduser("~/Downloads")
else:
    root_dir = os.path.expandvars("%SystemDrive%\\Temp")

file_count_limit = 1000
file_size_limit = 1024 * 1024
raw_dataset_csv_file_name = "_dataset.csv"
tmp_raw_file_path = os.path.join(root_dir, "_raw_files.csv")
tmp_filtered_file_path = os.path.join(root_dir, "_filtered_files.csv")

test_file_count_limit = 200

benign_scan_dirs = [
    os.path.expandvars("%ProgramFiles%"),
    os.path.expandvars("%ProgramFiles(x86)%"),
    os.path.expandvars("%WinDir%")
]

malware_scan_dir = [
    os.path.join(root_dir, "Virus.Win")
]

benign_scan_exts = [ ".acm", ".ax", ".cpl", ".dll", ".drv", ".efi", ".exe", ".mui", ".ocx", ".scr", ".sys", ".tsp" ]
malware_scan_exts = None

raw_benign_dataset_dir = os.path.join(root_dir, "benign_dataset")
raw_malware_dataset_dir = os.path.join(root_dir, "malware_dataset")

opcode_benign_dataset_csv_file_path = os.path.join(root_dir, "benign_opcodes.csv")
opcode_malware_dataset_csv_file_path = os.path.join(root_dir, "malware_opcodes.csv")

def init():
    maxInt = sys.maxsize

    while True:
        # decrease the maxInt value by factor 10
        # as long as the OverflowError occurs.

        try:
            csv.field_size_limit(maxInt)
            break
        except OverflowError:
            maxInt = int(maxInt / 10)

def generate_raw_dataset():

    if False:
        RawDatasetGenerator.generate(
            benign_scan_dirs,
            benign_scan_exts,
            raw_benign_dataset_dir,
            raw_dataset_csv_file_name,
            file_count_limit,
            file_size_limit,
            tmp_raw_file_path,
            tmp_filtered_file_path
        )

    if True:
        RawDatasetGenerator.generate(
            malware_scan_dir,
            malware_scan_exts,
            raw_malware_dataset_dir,
            raw_dataset_csv_file_name,
            file_count_limit,
            file_size_limit,
            tmp_raw_file_path,
            tmp_filtered_file_path
        )

    pass

def convert_raw_dataset_to_opcode_dataset():

    # Benign dataset
    if True:
        benign_file_paths = RawDatasetGenerator.load(raw_benign_dataset_dir, raw_dataset_csv_file_name,
                                                     [332], test_file_count_limit, file_size_limit)
        OpcodeDatasetGenerator.generate(benign_file_paths, opcode_benign_dataset_csv_file_path)

    # Benign dataset
    if True:
        malware_file_paths = RawDatasetGenerator.load(raw_malware_dataset_dir, raw_dataset_csv_file_name,
                                                     [332], test_file_count_limit, file_size_limit)
        OpcodeDatasetGenerator.generate(malware_file_paths, opcode_malware_dataset_csv_file_path)

    pass

def load_opcode_dataset():

    if True:
        benign_opcodes_dataset = OpcodeDatasetGenerator.load(opcode_benign_dataset_csv_file_path)
        benign_op_freq = []
        for opcodes in benign_opcodes_dataset:
            benign_op_freq.append(FeatureExtractor.extract_frequency(opcodes))

        malware_opcodes_dataset = OpcodeDatasetGenerator.load(opcode_malware_dataset_csv_file_path)
        malware_op_freq = []

        for index, opcodes in enumerate(malware_opcodes_dataset):
            if len(opcodes) == 0:
                continue
            malware_op_freq.append(FeatureExtractor.extract_frequency(opcodes))

        dataset = benign_op_freq + malware_op_freq
        labels = [0 for x in benign_op_freq] + [1 for x in malware_op_freq]

        DataTrainer.cross_train(dataset, labels)

        return

    pass

def test():

    dataset = make_moons(noise=0.3, random_state=0)

    DataTrainer.cross_train(dataset)

    return

if __name__ == '__main__':

    # test()

    init()

    if False:
        generate_raw_dataset()

    if False:
        convert_raw_dataset_to_opcode_dataset()

    if True:
        load_opcode_dataset()

    pass