import os
import glob
import csv
import pefile
import random

def enum_raw_pe_files(scan_dirs, csv_file_path):

    print("================")
    print(enum_raw_pe_files.__name__)

    pe_extensions = [".acm", ".ax", ".cpl", ".dll", ".drv", ".efi", ".exe", ".mui", ".ocx", ".scr", ".sys", ".tsp"]

    file_paths = []

    percentage = 0
    print(0, "%")

    total_items_count = len(scan_dirs) * len(pe_extensions)
    item_index = 0

    for dir_index, scan_dir in enumerate(scan_dirs):
        for ext_index, extension in enumerate(pe_extensions):

            if (int)(item_index * 100 / total_items_count) > percentage:
                percentage = (int)(item_index * 100 / total_items_count)
                print(percentage, "%")

            find_pattern = os.path.join(scan_dir, "**", "*" + extension)
            file_paths += glob.glob(find_pattern,  recursive=True)

            item_index += 1

    print("Saving...")

    with open(csv_file_path, 'w', newline='') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=['path'])
        writer.writeheader()
        for path in file_paths:
            writer.writerow({"path": path})

    print(100, "%")

def filter_pe_files(raw_csv_path, filtered_csv_path, file_count_limit):

    print("================")
    print(filter_pe_files.__name__)

    file_paths = []

    percentage = 0
    print(0, "%")

    with open(raw_csv_path, newline='') as csv_file:
        reader = csv.DictReader(csv_file)
        for row in reader:
            file_paths.append(row["path"])

    file_count_limit = min(len(file_paths), file_count_limit)
    randomized_file_indexes = [x for x in range(0, len(file_paths))]
    random.shuffle(randomized_file_indexes)

    pe_files = []
    for file_index in randomized_file_indexes:

        if len(pe_files) >= file_count_limit:
            break

        if (int)(len(pe_files) * 100 / file_count_limit) > percentage:
            percentage = (int)(len(pe_files) * 100 / file_count_limit)
            print(percentage, "%")

        try:
            pe = pefile.PE(file_paths[file_index])
            file_header = pe.FILE_HEADER

            machine = file_header.Machine

            # only accept x64 and x86 machine type
            if machine == 0x8664 or machine == 0x14c:
                pe_files.append({"path": file_paths[file_index], "machine": machine})

        except:
            pass

    print("Saving...")

    with open(filtered_csv_path, 'w', newline='') as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=["path", "machine"])
        writer.writeheader()
        for pe_file in pe_files:
            writer.writerow(pe_file)

    print(100, "%")

    pass

if __name__ == '__main__':

    enum_raw = False

    raw_csv_path = os.path.expandvars("%SystemDrive%\\Temp\\_raw_files.csv")
    filtered_csv_path = os.path.expandvars("%SystemDrive%\\Temp\\_filtered_files.csv")

    if enum_raw:
        enum_raw_pe_files([os.path.expandvars("%ProgramFiles%"), os.path.expandvars("%ProgramFiles(x86)%")], raw_csv_path)

    filter_pe_files(raw_csv_path, filtered_csv_path, 1000)

    print("DONE")

    pass